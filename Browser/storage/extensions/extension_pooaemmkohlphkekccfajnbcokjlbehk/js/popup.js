class Popup{constructor(){this.settingsPanel=document.querySelector(".top-settings-panel"),this.paramsList=document.querySelector(".params-list"),this.themeLink=document.querySelector("#theme-link"),this.storage=null,this.currentTab=null,this.audio=null,this.run()}run(){this.initStorage().then((()=>this.getCurrentTab())).then((()=>{this.showActiveSelect(),this.createAudio(),this.setTimePeriod(),this.setTimeInterval(),this.initializeBeautySelect(),this.setThemeMode(),this.fillSelectedParams(),this.initListeners()}))}showActiveSelect(){const e=document.querySelector(".clearing-period"),t=document.querySelector(".clearing-interval");"off"===this.storage.timeInterval?(this.hideElement({element:t}),this.showElement({element:e})):(this.hideElement({element:e}),this.showElement({element:t}))}createAudio(){const e=chrome.runtime.getURL("audios/accomplished.mp3");this.audio=new Audio(e),this.audio.loop=!1}getCurrentTab(){return new Promise((e=>{chrome.tabs.query({active:!0,currentWindow:!0},(t=>{this.currentTab=t[0],e()}))}))}setTimePeriod(){document.querySelector(".time-period-select").value=this.storage.timePeriod}setTimeInterval(){document.querySelector(".time-interval-select").value=this.storage.timeInterval}initializeBeautySelect(){$(document).ready((function(){$(".time-period-select").niceSelect(),$(".time-interval-select").niceSelect()}))}initStorage(){return new Promise((e=>{chrome.storage.local.get((t=>{this.storage=t,e()}))}))}fillSelectedParams(){JSON.parse(this.storage.dataToRemove).forEach((e=>{const t=document.querySelector(`#${e}`);t&&(t.checked=!0)}))}setThemeMode(){let e;if("light"===this.storage.theme)e=chrome.runtime.getURL("css/popup/light.css");else{e=chrome.runtime.getURL("css/popup/dark.css");document.querySelector(".dark-theme-toggling").classList.add("dark")}this.themeLink.href=e}initListeners(){this.initStorageListeners(),this.initDomListeners()}initStorageListeners(){chrome.storage.onChanged.addListener((e=>this.handleStorageChanges(e)))}handleStorageChanges(e){Object.keys(e).forEach((t=>{this.storage[t]=e[t].newValue}))}initDomListeners(){let e=+this.storage.clickCountFromPopup+ +this.storage.clickCountFromOptions;this.settingsPanel.addEventListener("click",(e=>this.handleSettingsPanelClick(e))),$(".clearing-period").on("change","select",(e=>{chrome.storage.local.set({timePeriod:e.target.value},(()=>{}))})),$(".clearing-interval").on("change","select",(e=>{chrome.storage.local.set({timeInterval:e.target.value},(()=>{}))})),$(".input-part input").on("change",(e=>{this.handleSingleChekingChange(e)})),$(".control-item").on("click",(e=>{this.handleControlElement(e)})),$(".clear-btn").on("click",(e=>this.handleClearBtn(e))),!this.storage.isConfirm&&e<=25&&$("body").on("click",(()=>{let t,s=0;if(s=e++,chrome.storage.local.set({clickCountFromPopup:s}),25===s){if((t=confirm("Please share your experience with others and make a review for us."))&&chrome.tabs.create({url:"https://chrome.google.com/webstore/detail/"+chrome.runtime.id+"/reviews",selected:!0},(function(e){})),t)return $("body").prop("onclick",null).off("click"),void chrome.storage.local.set({isConfirm:t});s=0,chrome.storage.local.set({clickCountFromPopup:s,clickCountFromOptions:s}),window.close()}}))}handleSettingsPanelClick(e){const t=e.target,s=t.dataset.action;if(s)switch(s){case"all-selecting":this.handleAllSelectionSwitch(t);break;case"toggle-theme":this.handleThemeChange(t);break;case"open-options":this.showOptionsLink()}}handleAllSelectionSwitch(e){e.classList.toggle("all-selected");const t=e.classList.contains("all-selected");Array.from(this.paramsList.querySelectorAll("input")).forEach((e=>{e.checked=t;const s=e.id,i=t?"push":"splice";this.modifyDataToRemoveList(i,s)})),chrome.storage.local.set({dataToRemove:this.storage.dataToRemove},(()=>{}))}modifyDataToRemoveList(e,t){const s=JSON.parse(this.storage.dataToRemove),i=s.indexOf(t);if("push"===e&&0>i)s.push(t);else{if(0>i)return;s.splice(i,1)}this.storage.dataToRemove=JSON.stringify(s)}handleThemeChange(e){e.classList.toggle("dark");const t=e.classList.contains("dark");this.themeLink.href=t?chrome.runtime.getURL("css/popup/dark.css"):chrome.runtime.getURL("css/popup/light.css");const s=t?"dark":"light";chrome.storage.local.set({theme:s},(()=>{}))}showOptionsLink(){const e=chrome.runtime.getURL("options.html");chrome.tabs.query({currentWindow:!0},(t=>{let s=!1,i=null;t.forEach((t=>{t.url!==e||(s=!0,i=t.id)})),s?chrome.tabs.update(i,{highlighted:!0},(()=>{})):chrome.tabs.create({url:e},(()=>{}))}))}handleSingleChekingChange(e){const t=e.target.id,s=e.target.checked,i=JSON.parse(this.storage.dataToRemove),o=i.indexOf(t);s&&0>o?i.push(t):-1<o&&i.splice(o,1),this.storage.dataToRemove=JSON.stringify(i),chrome.storage.local.set({dataToRemove:this.storage.dataToRemove},(()=>{}))}handleControlElement(e){const t=e.target;if(t.dataset.page_link){const e=t.dataset.page_link;chrome.tabs.create({url:e},(()=>{}))}else this.removeSingleParamInfo(e.target)}removeSingleParamInfo(e){if(!e.classList.contains("animated")&&!e.classList.contains("scaled")){const t=e.dataset.param;return t?"passwords"===t?void this.tryToRemovePasswords():void chrome.runtime.sendMessage({action:"clear",tab:this.currentTab,removeObject:{[t]:!0}},(()=>{this.animateDeleteControlButton(e)})):void 0}}animateDeleteControlButton(e){e.classList.add("scaled"),this.audio.volume=this.storage.audio?1:0,this.audio.play(),this.animateSingleDeleting(e)}animateSingleDeleting(e){return new Promise((t=>{e.classList.add("scaled"),setTimeout((()=>{e.classList.remove("scaled"),e.classList.add("animated"),t(e)}),300)})).then((e=>{setTimeout((()=>{e.classList.remove("animated")}),2e3)}))}tryToRemovePasswords(){this.acceptPasswordDeleting().then((e=>{this.deleteCurrentWindow(),"ok"===e&&chrome.runtime.sendMessage({action:"clear",tab:this.currentTab,removeObject:{passwords:!0}},(()=>{}))}))}acceptPasswordDeleting(){return new Promise(((e,t)=>{this.createDialogWindow("passwords",e,t)}))}createDialogWindow(e,t){const s={passwords:"Passwords will be cleared.<br /> Are you sure?","сhosenElems":"Please, confirm data removing"}[e],i=this.createDialog(s);this.addDialogListeners(i,t),document.body.appendChild(i)}createDialog(e){return document.createRange().createContextualFragment(`\t\t<section class="dialog-window" id="chosen-elems-accepting">\t\t\t<div class="dialog-window-item">\t\t\t\t<h2 class="dialog-header">${e}</h2>\t\t\t\t<div class="control-buttons">\t\t\t\t\t<span class="ok">ok</span>\t\t\t\t\t<span class="cancel">cancel</span>\t\t\t\t</div>\t\t\t</div>\t\t</section>\t\t`)}addDialogListeners(e,t){const s=e.querySelector(".ok"),i=e.querySelector(".cancel");s.addEventListener("click",(()=>t("ok"))),i.addEventListener("click",(()=>t("cancel")))}deleteCurrentWindow(){document.querySelector(".dialog-window").remove()}handleClearBtn(){const e=JSON.parse(this.storage.dataToRemove),t={};e.forEach((e=>t[e]=!0));const s=e.includes("passwords"),i=Object.keys(t).length;s?1===i?this.acceptPasswordDeleting().then((e=>{this.deleteCurrentWindow(),"cancel"===e||chrome.runtime.sendMessage({action:"clear",tab:this.currentTab,removeObject:t},(()=>{this.showSuccessDeletingStatus()}))})):this.acceptPasswordDeleting().then((e=>{this.deleteCurrentWindow(),"cancel"===e&&delete t.passwords,chrome.runtime.sendMessage({action:"clear",tab:this.currentTab,removeObject:t},(()=>{this.showSuccessDeletingStatus()}))})):chrome.runtime.sendMessage({action:"clear",tab:this.currentTab,removeObject:t},(()=>{this.showSuccessDeletingStatus()}))}showSuccessDeletingStatus(){const e=document.querySelector(".clear-btn");if(e.className.split(" ").includes("animated"))return;const t=e.querySelector(".clear-btn_text"),s=e.querySelector(".success_img"),i=e.querySelector(".top_layer");this.hideElement({element:t}),e.classList.add("animated"),this.audio.volume=this.storage.audio?1:0,this.audio.play(),new Promise((e=>{setTimeout((()=>{this.showElement({element:s}),this.hideElement({element:i}),this.audio.pause(),this.audio.currentTime=0,e()}),800)})).then((()=>{setTimeout((()=>{this.hideElement({element:s}),this.showElement({element:t}),this.showElement({element:i}),e.classList.remove("animated")}),1e3)}))}showElement(e){e&&"object"==typeof e&&Object.keys(e).length&&(e.element?e.element.classList.remove("hidden"):e.selector&&document.querySelector(e.selector).classList.remove("hidden"))}hideElement(e){e&&"object"==typeof e&&Object.keys(e).length&&(e.element?e.element.classList.add("hidden"):e.selector&&document.querySelector(e.selector).classList.add("hidden"))}acceptDeleteCheckedParams(){return new Promise(((e,t)=>{this.createDialogWindow("сhosenElems",e,t)}))}}const guruPopup=new Popup;